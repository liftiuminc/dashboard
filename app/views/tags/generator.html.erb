<% title "Tag Generator / Publisher Preview" %>

<% # FIXME: How do I put this in the model?

    # Get the list of publishers for admin users
    @publishers = Publisher.find :all;
%>
<script>
var dimRegexp = /^([0-9]{2,4})x([0-9]{2,4})/;
var deliveryHost = "http://cdn.liftium.com";
var deliveryHost = "http://nick.dev.liftium.com";
function generateTag(f) {
  try {
	var pubid = $("pubid").value;
	if (pubid == ""){
		alert("You must select a publisher to continue.");	
		return false;
	}
	var size = $("size").value;
	if (size == ""){
		alert("You must select a size to continue.");	
		return false;
	}
	var delivery = $("delivery_iframe").checked ? "iframe" : "script";
	var comments = $("comments").checked;

	if (delivery == "iframe") {
		var t = $("tag").value = generateIframeTag(pubid, size, comments);
		$("tag").value = t;
		if ($("preview").checked){
			$("preview_div").innerHTML = t;
			$("preview_iframe").hide();
			$("preview_div").show();
		}
	} else {
		$("tag").value = generateScriptTag(pubid, size, comments);
		if ($("preview").checked){
			$("preview_div").innerHTML = "";
			doPreview();
		}
	}

	return false;
  } catch (e) {
	alert("Tag Generator Error " + e.message);
	return false;
  }
}

function generateIframeTag (pubid, size, comments){
	var url = deliveryHost + "/tag_iframe?pubid=" + pubid + '&size=' + size
	var t = '';
	if (comments){ t += '<!-- Begin Liftium Tag. -->\n'; }

	var dim = size.match(dimRegexp);
	if (! dim){
		return false;
	}

	t += '<iframe src="' + url + '" width="' + dim[1] + '" height="' + dim[2] + '"' + 
		' noresize="true" scrolling="no" frameborder="0" marginheight="0"' +
		' marginwidth="0" style="border:none" target="_blank"></iframe>';

	if (comments){ t += '<!-- End Liftium Tag -->\n'; }
	return t;
}

function generateScriptTag (pubid, size, comments){
	var t = '';
	if (comments){
		t += '<!-- Begin Liftium set up. \n' +
		     'This only needs to appear once on your page, anywhere above the tag is ok. -->\n';
	}

	t += '<script>LiftiumOptions = {pubid:' + pubid + '}</\script>\n' +
	    '<script src="' + deliveryHost + '/js/Liftium.js"><\/script>\n';

	if (comments){ t += '<!-- End Liftium set up -->\n'; }
	if (comments){ t += '<!-- Display Tag. Put this in the exact place where you want the ad -->\n'; }
	t += '<script>Liftium.callAd("' + size + '")<\/script>';
	return t;
}

function doPreview(){
	var size = $("size").value;
	var dim = size.match(dimRegexp);
	if (! dim){
		return false;
	}

	iframe = document.getElementById("preview_iframe");
	iframe.width=dim[1];
	iframe.height=dim[2];
	iframe.style.display="block";

	var f = document.getElementById("preview_form");
	f.html.value = $("tag").value; 
	f.submit();
}
</script>

<form onSubmit="return generateTag(this);">
  <div class="fieldset">
    <%= label_tag :publisher, nil, :class => "left_label" %>
    <select name="pubid" id="pubid">
    <option value="">Select a Publisher
    <%= options_from_collection_for_select(@publishers, :id, :site_name) %>
    </select>
  </div>
  <div class="fieldset">
    <%= label_tag :size, nil, :class => "left_label" %>
    <select name="size" id="size">
    <option value="">Select a Size
    <%= options_from_collection_for_select(AdFormat.all.collect, :size, :name_with_size) %>
    </select>
  </div>
  <div class="fieldset">
    <%= label_tag :options, nil, :class => "left_label" %>
    <%= check_box_tag("comments", 1, true) %><%= label_tag :comments, "Helpful comments" %> 
    <%= check_box_tag("preview", 1, true) %><%= label_tag :preview, "Show Preview" %>
  </div>
  <div class="fieldset">
    <%= label_tag :delivery, "Delivery Method", :class => "left_label" %>
    <%= radio_button_tag("delivery", "script", true) %>Inline Javascript <span class="hint">(recommended)</span>
    <%= radio_button_tag("delivery", "iframe", false) %>Iframe
  </div>
  <div class="fieldset" id="tag_template_fieldset">
    <%= label_tag :tag %><br />
    <%= text_area_tag :tag, nil, :class => "tag_input" %>
  </div>
  <p><%= liftium_submit "Generate Tag" %></p>
</form>
<!-- FIXME: form for remote ?-->
<form id="preview_form" target="preview_iframe" method="post" action="/tags/html_preview"><!-- FIXME: url for html preview? -->
<input type="hidden" name="html"/>
</form>
<iframe name="preview_iframe" id="preview_iframe" style="border: 1px dashed #660099;display:none"></iframe>
<div id="preview_div" style="border: 1px dashed #660099;display:none"></div>
